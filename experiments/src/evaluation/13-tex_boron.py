import numpy as np
import grammar_v_mtllm.utils_fig

def cellcolor(value, vmin=0, vmax=1):
    if value < 0:
        base_color = "Blue3"
    else:
        base_color = "Brown3"

    value_str = (abs(value) - vmin) / (vmax - vmin)*50


    return r"\cellcolor{" + base_color + "!" + f"{value_str:.0f}" + r"}"

def microplot(points):
    return "\microplot{\n" + "\n".join([f"({x:.2f}, {y:.2f})" for x, y in points]) + "\n}"

def process_cell(corr, points):
    if corr > 0:
        value_prefix = r"\phantom{-}"
    else:
        value_prefix = ""


    return cellcolor(corr) + r"\hspace{-2mm}\raisebox{2mm}{" + f"{value_prefix} {corr:.2f} " + r"}" + microplot(points)


PROMPTS = [0, 1, 3, 2]

DATA_CORR = {'noising_L2': {0: 0.7096968862085662, 1: 0.4600727344309935, 2: 0.1373168287131604, 3: 0.4700333996390263}, 'noising_LazyUser': {0: 0.9377710564937806, 1: 0.7651680957633882, 2: 0.5181376508183871, 3: 0.3639372934737929}, 'noising_lexicalphrasal': {0: 0.5067378734374537, 1: 0.5859266971752077, 2: -0.6722729423598935, 3: 0.29783161248693824}, 'noising_llm': {0: 0.8370846316192802, 1: 0.7191985872244931, 2: 0.5699810847621477, 3: 0.8629553432688191}, 'noising_orthographic': {0: 0.7053778782097951, 1: 0.5840533253879365, 2: 0.6713015246402438, 3: -0.012585437401121542}, 'noising_register': {0: 0.7444589894701672, 1: 0.8782546386807204, 2: -0.16999181952559456, 3: 0.30585922578452396}, 'noising_typos_synthetic': {0: 0.8640981658055105, 1: 0.9237912556873724, 2: 0.6117439958058595, 3: 0.6770739339088172}}
DATA_XY = {'noising_L2': {2: [(0.8884680468828735, 0.7624069355082496), (0.9481732352609406, 0.7726808023864286), (0.8116878165749257, 0.7519192373494054), (0.6835832790498962, 0.7473653392025746), (0.9024114112059275, 0.7502821897146307), (0.917522976194575, 0.7199685995777448), (0.8760538999274343, 0.7359741211014328), (0.8332712540937042, 0.7376200267566985), (0.9142788543251699, 0.7529760939180784)], 3: [(0.8821059479437663, 0.7699454432844822), (0.9268670578797659, 0.7796301522585101), (0.9559815514985555, 0.7856201752836569), (0.9394733215415192, 0.7933783376214885), (0.9200232215618184, 0.7442332282495375), (0.9679594629950866, 0.7890102692287456), (0.8635445817172648, 0.7821077686174785), (0.8731946752520854, 0.7925599222542244), (0.8056871396320546, 0.7762880518371095), (0.7666088523311055, 0.7468768533747631)], 0: [(0.9704477774992676, 0.7555102640735785), (0.9444982603148905, 0.7567082661229301), (0.9360385322431843, 0.7348383567263609), (0.9028737244986013, 0.7203759852328313), (0.9215733683902944, 0.7014041213117034), (0.9130976780116679, 0.6852419596834317), (0.8902687419358724, 0.6403752472038708), (0.8314442127856191, 0.6869278471683927), (0.9656641669963887, 0.7209308438422273), (0.7976407886379852, 0.6643605695106716)], 1: [(0.9059930449776307, 0.762512993026584), (0.9979757268221435, 0.7976048952045796), (0.8074077985875143, 0.7650361190800762), (0.8390255367721151, 0.7914969275578793), (0.9221740774417827, 0.7955043467320794), (0.8534939401461334, 0.7582087432525132), (0.8610197300668844, 0.7722665035846228), (0.7684623414399618, 0.7598768827780777), (0.8452810657128601, 0.7671821785381332), (0.8881422284271545, 0.7391508217116851)]}, 'noising_LazyUser': {2: [(0.8187522683488871, 0.763297507528953), (0.9434395730495453, 0.7619690042647966), (0.7816309825544586, 0.7505245473761111), (0.9446892139289551, 0.7721289947872818), (0.882346629996226, 0.7450336302757744), (0.8341103881510671, 0.7362317904976953), (0.8089456159861145, 0.6569286862234182), (0.7715633110170593, 0.6352054576847324), (0.8365959419754689, 0.6119178326988776), (0.8300171884833577, 0.6470586710301143)], 3: [(0.7587068952925669, 0.7529829137646893), (0.9490768100696411, 0.7875655952008469), (0.8438493704761099, 0.7542046902826938), (0.9503790620823821, 0.7860572418054773), (0.9043223845854492, 0.7856159585807201), (0.8379655752353565, 0.7356640590069621), (0.8404209208418986, 0.7828426758214461), (0.8317019929401651, 0.7129763497068486), (0.8346668580165761, 0.7439342586065162), (0.8438594627276154, 0.5957435290409535)], 0: [(0.9957188142104898, 0.7604175685376523), (0.9512401216168009, 0.7684865928342913), (0.9219796049490662, 0.7368249614388787), (0.8797346251183522, 0.7208133391790448), (0.830984721380722, 0.6719969948580435), (0.8734130063644308, 0.6796871393959075), (0.7822410050888976, 0.5861953482402598), (0.8067174153500569, 0.6516953136398637), (0.7607569482809651, 0.5325234617350668), (0.7630720222859446, 0.5312504877032146)], 1: [(0.9903175135453542, 0.799789517366333), (0.9615595939781494, 0.795700453148311), (0.7051741994067282, 0.7050504664640153), (0.7835175096988678, 0.7657546804500946), (0.7989169559893494, 0.7700419086487778), (0.716840447097636, 0.7530978104691285), (0.7120040061093852, 0.7667881463159764), (0.7864375912175802, 0.7242625685443367), (0.5662828977867991, 0.47070366451656626), (0.7350275818541616, 0.686961592503044)]}, 'noising_lexicalphrasal': {2: [(0.9922345882706299, 0.769221849796337), (0.8701623070135803, 0.7783000516623586), (0.982121118493637, 0.7516007144851712), (0.856594621533905, 0.7772337825385558), (0.9076302856293742, 0.7540656401471182), (0.8898034501145223, 0.7631554450105723), (0.9643560256612752, 0.7461208013011399), (0.9803772562690124, 0.756214977820554), (0.8612219685263977, 0.773936972130617)], 3: [(0.9374176562834523, 0.7858635493422859), (0.951222122316803, 0.7888243586155658), (0.8965719843947602, 0.7930660721476611), (0.9909209018997803, 0.7873049110351216), (0.9865723842330322, 0.7956943484254948), (0.9415343387782694, 0.7712266844862433), (0.9728786933317871, 0.7851971785795312), (0.8465626233764038, 0.7797544225265401)], 0: [(0.9694800464208018, 0.7657373449916504), (0.9503231036558838, 0.7066043916521011), (0.9750553754861246, 0.7663553184029019), (0.9492468821898193, 0.7396594547695629), (0.973568170160436, 0.7374357520261304), (0.9534072869963989, 0.7534382553214558), (0.9671658271499023, 0.7303777511171684)], 1: [(0.9305273306473999, 0.7945024197016348), (0.8517665875062256, 0.7710889669941482), (0.8494097601469524, 0.7828886056228272), (0.8799665576271668, 0.8041296928680095), (0.9174464947037354, 0.7633764268076759), (0.8816185605630188, 0.7665601545112654), (0.8062772762879639, 0.7310730934851214)]}, 'noising_llm': {2: [(0.8969405287452087, 0.7355011753291993), (0.8095613718032837, 0.7252281246962795), (0.758639038811615, 0.7330022394787408), (0.8034149408340454, 0.7467669622613106), (0.8485146164894104, 0.7498308825963176), (0.8813973069190979, 0.7457952727216077), (0.868057131767273, 0.7508402776404818), (0.8017951822072448, 0.7359378927643457), (0.783445239668335, 0.7078753173221015), (0.8663434982299805, 0.7595848979800438)], 3: [(0.937737762928009, 0.7764275603696146), (0.7878869771957397, 0.7349165300200857), (0.795266746873413, 0.7204889035333809), (0.7386226051993713, 0.7022056315053313), (0.8387258636847229, 0.7841597519275507), (0.8798847794532776, 0.7710682114252619), (0.8027642977341919, 0.7499576184470219), (0.921195266225952, 0.7807165312709575), (0.8626344191923828, 0.762130993184782), (0.8181285256095275, 0.7430107610722316)], 0: [(0.665513277053833, 0.6282896960788419), (0.6742925643920898, 0.6629967430539261), (0.7472061502829285, 0.6435752217059738), (0.6660957336425781, 0.6072761413829794), (0.7721035468474121, 0.7028725955186872), (0.7878284448333129, 0.684346912048358), (0.8614244467072144, 0.6963950553447562), (0.7738686800003052, 0.6957403068246796), (0.8672201621428223, 0.6859653735726677), (0.8978847253218384, 0.7391122394287113)], 1: [(0.8023197066888123, 0.7694843659430869), (0.760019063949585, 0.768162013015467), (0.7830298530951233, 0.7650368435601033), (0.6234808576211243, 0.7410969046704226), (0.7398086798295288, 0.7693280709719102), (0.7196238642983094, 0.7636837539812343), (0.7158008211799011, 0.7759919525398665), (0.5976917129598693, 0.7458587793662153), (0.7471601963043213, 0.7689408916438062), (0.7625654929824218, 0.7525941237583472)]}, 'noising_orthographic': {2: [(1.0000001192092896, 0.7726136696055395), (0.8237929248844553, 0.7483867516190421), (0.8317715610938873, 0.7524853523981809), (0.941367010475942, 0.767106954481831), (0.8687862157821655, 0.7322817016154949), (0.7018254699327037, 0.7385026052781243), (0.7921311740943654, 0.7611878591417812), (0.9228873047171834, 0.7579218168341908), (0.914549609125529, 0.7662911642475584)], 3: [(0.9550456194980773, 0.791550533068979), (0.9643829063539734, 0.7913577449135357), (0.9352821506037089, 0.7888958808873914), (0.8634297633032124, 0.7802857922611817), (1.0000001192092896, 0.787308330803181), (0.7866827550556488, 0.7938360252276286), (0.916414099513509, 0.7798458737452931), (0.9221806816190541, 0.7874086434746024), (0.947062611579895, 0.7876805741623014), (0.845348555734141, 0.786793206639486)], 0: [(0.9994349967361806, 0.7506350675116363), (0.9574680115657653, 0.7391164016410311), (0.9945492638090058, 0.7586143345569341), (0.9260129122837218, 0.746360006740718), (0.8788267063990326, 0.7235393332786368), (0.9266370824903309, 0.7393107405427164), (0.889332702063146, 0.6997987227078057), (0.940657674564799, 0.7235101733496172), (0.843605068500361, 0.7273892761779938)], 1: [(0.9945763557234091, 0.7981655456658517), (0.9608148034378916, 0.8013644646740473), (0.8872466685391948, 0.7958844587544213), (0.8968932629633687, 0.7990283880919733), (0.9402552253059998, 0.7960136103068224), (0.8690843675481822, 0.7824223665606145), (0.8707848786305644, 0.7549231793231238), (0.855088214981425, 0.7709192794381677), (0.822789282107722, 0.766167181757995), (0.8441543784798381, 0.7993868979032707)]}, 'noising_register': {2: [(0.8818210363388062, 0.6999868363228862), (0.7952270495787354, 0.7737692249373079), (0.9886931168928833, 0.7588180051296047), (0.8818167448043823, 0.7736870276603269), (0.8963745224371643, 0.7535861745957728), (0.8607620578847961, 0.7669038065003323)], 3: [(0.866058169592926, 0.7788158664736639), (0.9494649177841797, 0.7741062937864298), (0.9490181803703308, 0.7828415026113715), (0.8653466094438069, 0.7694321795897189), (0.909476816052948, 0.7888326110730415)], 0: [(0.9479688399978027, 0.694997881032899), (0.9617470492832437, 0.7581435995444913), (0.9551064360037537, 0.7645305298156895), (0.9785866725340576, 0.7731667483395404)], 1: [(0.8131927448493754, 0.7993286972678822), (0.8332617890939026, 0.7440448802610038), (0.7464468286486918, 0.602051072018052), (0.7671862250618592, 0.5587026952020364), (0.8247154361061707, 0.7971385606409883)]}, 'noising_typos_synthetic': {2: [(0.9418600197598368, 0.7539118027084479), (0.849025011764089, 0.7447774101502156), (0.9371048924474539, 0.7637306533201049), (0.7508930957282614, 0.7611831816819798), (0.7175537445130462, 0.6830648991110827), (0.9212776811848145, 0.7360963366376234), (0.6766815992300619, 0.7098765416386896), (0.7186859356424408, 0.6894693252294621), (0.7839073244765371, 0.6314810375325804), (0.7023356159528097, 0.6443525886714686)], 3: [(0.9911772012710571, 0.7857781815885616), (0.8749874236203715, 0.7611841576094986), (0.8983644427699483, 0.7682704172278567), (0.925119340018931, 0.7817367897175855), (0.8063742506399841, 0.7674226118337277), (0.7571597781664479, 0.6913287877298289), (0.7845841437491353, 0.727195611883709), (0.8459956743302459, 0.7763776591749529), (0.7811064221444244, 0.6394906524177144), (0.7867302185175424, 0.5870838528926986)], 0: [(0.9783409712520904, 0.7572987690080284), (0.882287232464564, 0.7349708342172725), (0.9125205069693502, 0.7290728345389752), (0.7892631762994028, 0.7369297536027803), (0.8541302555573679, 0.7043676633263377), (0.8566653828828278, 0.6245674543304846), (0.7558671628392029, 0.611708137731372), (0.7059873527166849, 0.5247255865149609), (0.6806473127931416, 0.3962912876538914), (0.7028757812423146, 0.4861244375336681)], 1: [(0.9411645732340699, 0.8005454608796023), (0.8456059988305002, 0.7806471146708298), (0.8291012048721313, 0.7779092247765098), (0.8413917225616658, 0.763924442460467), (0.7608172392810415, 0.6856289262599646), (0.6807198026767629, 0.6422580060446992), (0.7029013830405986, 0.6510120018184306), (0.6554248025935211, 0.511493060975846), (0.6472486263565674, 0.49926693389612686)]}}


fout = open("figures/13-tex_boron.tex", "w")

print(
    r"\begin{tabular}{lllll@{\hspace{7mm}}l}\toprule",
    file=fout,
)
print(
    r"\bf Noiser",
    r"\bf Prompt 1",
    r"\bf Prompt 2",
    r"\bf Prompt 3",
    r"\bf Prompt 4",
    r"\bf All prompts",
    sep=" & ",
    end="\\\\\n",
    file=fout,
)
print(
    r"\midrule",
    file=fout,
)

for noiser, noiser_name in grammar_v_mtllm.utils_fig.NOISER_TO_NAME.items():
    print(
        r"\raisebox{2mm}{" + noiser_name + "}",
        *[process_cell(DATA_CORR[noiser][i], DATA_XY[noiser][i]) for i in PROMPTS],
        process_cell(np.average([DATA_CORR[noiser][i] for i in PROMPTS]), [xy for l in DATA_XY[noiser].values() for xy in l]),
        sep=" & ",
        end="\\\\\n",
        file=fout,
    )

print(
    r"\null\\[-0.5em]",
    file=fout,
)
print(
    r"\bf \raisebox{2mm}{All noisers}",
    *[
        process_cell(
            np.average([DATA_CORR[noiser][i] for noiser in grammar_v_mtllm.utils_fig.NOISER_TO_NAME.keys()]),
            [xy for noiser in grammar_v_mtllm.utils_fig.NOISER_TO_NAME.keys() for xy in DATA_XY[noiser][i]],
        )
        for i in PROMPTS
    ],
    process_cell(
        np.average([DATA_CORR[noiser][i] for noiser in grammar_v_mtllm.utils_fig.NOISER_TO_NAME.keys() for i in PROMPTS]),
        [xy for noiser in grammar_v_mtllm.utils_fig.NOISER_TO_NAME.keys() for i in PROMPTS for xy in DATA_XY[noiser][i]],
    ),
    sep=" & ",
    end="\\\\\n",
    file=fout,
)


print(
    r"\bottomrule\end{tabular}",
    file=fout,
)